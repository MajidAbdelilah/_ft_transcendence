<!DOCTYPE html>
<html>
<head>
    <title>Ping Pong Tournament</title>
</head>
<body>
    <div>
        <label for="roomName">Room Name:</label>
        <input type="text" id="roomName" placeholder="Enter room name">
        <label for="tournamentRoomName">Tournament Room Name:</label>
        <input type="text" id="tournamentRoomName" placeholder="Enter tournament room name">
        <button onclick="initializeWebSocket()">Start Game</button>
    </div>
    <div id="tournamentList"></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // Display tournaments data
        function displayTournaments(tournaments) {
            const tournamentList = document.getElementById('tournamentList');
            tournamentList.innerHTML = '';
            tournaments.forEach(tournament => {
                const tournamentDiv = document.createElement('div');
                tournamentDiv.className = 'tournament';
                tournamentDiv.innerHTML = `<strong>Tournament Date:</strong> ${tournament.date} <strong>Winner:</strong> ${tournament.winner}`;
                tournament.matches.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match';
                    matchDiv.innerHTML = `
                        <strong>Match:</strong> ${match.player1_username} vs ${match.player2_username} 
                        <strong>Score:</strong> ${match.player1_score} - ${match.player2_score} 
                        <strong>Winner:</strong> ${match.winner} 
                        <strong>Date:</strong> ${match.date}
                    `;
                    tournamentDiv.appendChild(matchDiv);
                });
                tournamentList.appendChild(tournamentDiv);
            });
        }

        let socket;

        // Initialize WebSocket for PingPong game
        function initializeWebSocket() {
            const roomName = document.getElementById('roomName').value || 'default_room' + Math.random();
            const tournamentRoomName = document.getElementById('tournamentRoomName').value;
            const url = tournamentRoomName ? 
                `ws://127.0.0.1:8001/ws/tournament/${roomName}/${tournamentRoomName}/` : 
                `ws://127.0.0.1:8001/ws/tournament/${roomName}/`;

            socket = new WebSocket(url);

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if(player === '') {
                    if(data.players.player1.full === false) {
                        player = 'player1';
                    } else if (data.players.player2.full === false) {
                        player = 'player2';
                    }
                }
                updateGame(data);
            };

            socket.onclose = function(e) {
                console.error('WebSocket closed unexpectedly');
            };
        }

        // Update game state
        function updateGame(data) {
            console.log(data);
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = data.width;
            canvas.height = data.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw ball
            ctx.beginPath();
            ctx.arc(data.ball.x, data.ball.y, data.ball.radius, 0, Math.PI * 2);
            ctx.fill();

            // draw scores big in the middle of the canvas in a transparent black in a good font
            ctx.font = '100px Arial';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillText(data.players.player1.score, canvas.width / 2 - 150, canvas.height / 2 + 50);
            ctx.fillText(data.players.player2.score, canvas.width / 2 + 50, canvas.height / 2 + 50);


            // Draw players
            ctx.fillRect(data.players.player1.x, data.players.player1.y, data.players.player1.width, data.players.player1.height);
            ctx.fillRect(data.players.player2.x, data.players.player2.y, data.players.player2.width, data.players.player2.height);
        }

        // Handle key events to control paddles
        document.addEventListener('keydown', function(event) {
            let direction = null;
            if (event.key === 'ArrowUp') {
                direction = 'up';
            } else if (event.key === 'ArrowDown') {
                direction = 'down';
            }

            if (direction) {
                socket.send(JSON.stringify({
                    'player': player, // Change as needed to identify the player
                    'direction': direction
                }));
            }
        });

        document.addEventListener('keyup', function(event) {
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                socket.send(JSON.stringify({
                    'player': player, // Change as needed to identify the player
                    'direction': null
                }));
            }
        });

        // Fetch tournaments for a specific user
        function fetchTournaments(username) {
            fetch(`/api/tournaments/${username}/`)
                .then(response => response.json())
                .then(data => displayTournaments(data))
                .catch(error => console.error('Error fetching tournaments:', error));
        }
        username = 'example_username'; // Change 'example_username' as needed
        player = ''; // Change as needed to identify the player
        fetchTournaments('example_username'); // Change 'example_username' as needed
    </script>
</body>
</html>