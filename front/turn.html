<!DOCTYPE html>
<html>
<head>
    <title>Ping Pong Tournament</title>
</head>
<body>
    <div>
        <label for="username">username</label>
        <input type="text" id="username" placeholder="Enter username">
        <label for="roomName">Room Name:</label>
        <input type="text" id="roomName" placeholder="Enter room name">
        <label for="tournamentRoomName">Tournament Room Name:</label>
        <input type="text" id="tournamentRoomName" placeholder="Enter tournament room name">
        <button onclick="initializeWebSocket()">Start Game</button>
    </div>
    <div id="tournamentList"></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        let socket;
        let player = '';
        let gameStarted = false;

        // Display tournaments data
        function displayTournaments(tournaments) {
            const tournamentList = document.getElementById('tournamentList');
            tournamentList.innerHTML = '';
            tournaments.forEach(tournament => {
                const tournamentDiv = document.createElement('div');
                tournamentDiv.className = 'tournament';
                tournamentDiv.innerHTML = `<strong>Tournament Date:</strong> ${tournament.date} <strong>Winner:</strong> ${tournament.winner}`;
                tournament.matches.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match';
                    matchDiv.innerHTML = `
                        <strong>Match:</strong> ${match.player1_username} vs ${match.player2_username} 
                        <strong>Score:</strong> ${match.player1_score} - ${match.player2_score} 
                        <strong>Winner:</strong> ${match.winner} 
                        <strong>Date:</strong> ${match.date}
                    `;
                    tournamentDiv.appendChild(matchDiv);
                });
                tournamentList.appendChild(tournamentDiv);
            });
        }

        // Initialize WebSocket for PingPong game
        function initializeWebSocket() {
            const username = document.getElementById('username').value;
            const roomName = document.getElementById('roomName').value;
            const tournamentRoomName = document.getElementById('tournamentRoomName').value;
            const url = tournamentRoomName ? 
                `ws://127.0.0.1:8001/ws/tournament/${roomName}/${tournamentRoomName}/` : 
                `ws://127.0.0.1:8001/ws/tournament/${roomName}/`;

            socket = new WebSocket(url);
            
            socket.onopen = function() {
                socket.send(JSON.stringify({
                    'player': player,
                    'direction': null,
                    'username': username,
                    'gameStarted': gameStarted
                }));
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log("data:", data.start_game);
                if(data.start_game === false){
                    console.log('Game not started');
                    socket.close();
                    alert('Game Over');
                    return;
                }
                if (data.players.player1.username === username) {
                    player = 'player1';
                } else if (data.players.player2.username === username) {
                    player = 'player2';
                }
                console.log('player:', player);
                updateGame(data);
            };

            socket.onclose = function(e) {
                console.log('WebSocket closed');
            };
        }

        // Update game state
        function updateGame(data) {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            console.log('gameStarted:', gameStarted);
            canvas.width = data.width;
            canvas.height = data.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(gameStarted === false){
                // print press space to start
                ctx.font = '30px Arial';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillText('Press Space to Start', canvas.width / 2 - 150, canvas.height / 2 + 50);
                return;
            }
            // Draw ball
            ctx.beginPath();
            ctx.arc(data.ball.x, data.ball.y, data.ball.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw scores
            ctx.font = '100px Arial';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillText(data.players.player1.score, canvas.width / 2 - 150, canvas.height / 2 + 50);
            ctx.fillText(data.players.player2.score, canvas.width / 2 + 50, canvas.height / 2 + 50);
            
            // Draw players
            ctx.fillRect(data.players.player1.x, data.players.player1.y, data.players.player1.width, data.players.player1.height);
            ctx.fillRect(data.players.player2.x, data.players.player2.y, data.players.player2.width, data.players.player2.height);
            
        }
        
        // Handle key events to control paddles
        document.addEventListener('keydown', function(event) {
            if (!gameStarted && event.key === ' ') {
                gameStarted = true;
            }

            let direction = null;
            if (event.key === 'ArrowUp') {
                direction = 'up';
            } else if (event.key === 'ArrowDown') {
                direction = 'down';
            }

            if (direction && gameStarted) {
                socket.send(JSON.stringify({
                    'player': player,
                    'direction': direction,
                    'username': username,
                    'gameStarted': gameStarted
                }));
            }
        });

        document.addEventListener('keyup', function(event) {
            if ((event.key === 'ArrowUp' || event.key === 'ArrowDown') && gameStarted) {
                socket.send(JSON.stringify({
                    'player': player,
                    'direction': null,
                    'username': username,
                    'gameStarted': gameStarted
                }));
            }
        });

        // Fetch tournaments for a specific user
        function fetchTournaments(username) {
            fetch(`/api/tournaments/${username}/`)
                .then(response => response.json())
                .then(data => displayTournaments(data))
                .catch(error => console.error('Error fetching tournaments:', error));
        }

        fetchTournaments('example_username'); // Change 'example_username' as needed
    </script>
</body>
</html>