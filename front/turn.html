<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Dashboard</title>
    <style>
        #tournaments {
            margin-bottom: 20px;
        }
        .tournament {
            margin-bottom: 10px;
        }
        .match {
            margin-left: 20px;
        }
        #gameCanvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Game Dashboard</h1>
    <div id="tournaments">
        <h2>Tournaments</h2>
        <div id="tournamentList"></div>
    </div>
    <div id="pingpongGame">
        <h2>PingPong Game</h2>
        <canvas id="gameCanvas" width="100" height="100"></canvas>
    </div>

    <script>
        // Fetch tournaments data
        async function fetchTournaments(username) {
            const response = await fetch(`http://127.0.0.1:8000/turn/tournaments/${username}/`);
            const data = await response.json();
            displayTournaments(data);
        }

        // Display tournaments data
        function displayTournaments(tournaments) {
            const tournamentList = document.getElementById('tournamentList');
            tournamentList.innerHTML = '';
            tournaments.forEach(tournament => {
                const tournamentDiv = document.createElement('div');
                tournamentDiv.className = 'tournament';
                tournamentDiv.innerHTML = `<strong>Tournament Date:</strong> ${tournament.date} <strong>Winner:</strong> ${tournament.winner}`;
                tournament.matches.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match';
                    matchDiv.innerHTML = `
                        <strong>Match:</strong> ${match.player1_username} vs ${match.player2_username} 
                        <strong>Score:</strong> ${match.player1_score} - ${match.player2_score} 
                        <strong>Winner:</strong> ${match.winner} 
                        <strong>Date:</strong> ${match.date}
                    `;
                    tournamentDiv.appendChild(matchDiv);
                });
                tournamentList.appendChild(tournamentDiv);
            });
        }

        // Initialize WebSocket for PingPong game
        const roomName = 'default_room' + Math.random(); // Change as needed
        const socket = new WebSocket(`ws://127.0.0.1:8001/ws/pingpong/${roomName}/`);

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            updateGame(data);
        };

        socket.onclose = function(e) {
            console.error('WebSocket closed unexpectedly');
        };

        // Update game state
        function updateGame(data) {
            console.log(data);
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = data.width;
            canvas.height = data.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // render the score
            ctx.font = '16px Arial';
            ctx.fillStyle = 'black';
            ctx.fillText(data.players.player1.score, 10, 20);
            ctx.fillText(data.players.player2.score, canvas.width - 20, 20);


            // Draw ball
            ctx.beginPath();
            ctx.arc(data.ball.x, data.ball.y, 5, 0, Math.PI * 2);
            ctx.fill();

            // Draw players
            ctx.fillRect(data.players.player1.x, data.players.player1.y, data.players.player1.width, data.players.player1.height);
            ctx.fillRect(data.players.player2.x, data.players.player2.y, data.players.player2.width, data.players.player2.height);
        }
        // Handle key events to control paddles
        document.addEventListener('keydown', function(event) {
            let direction = null;
            if (event.key === 'ArrowUp') {
                direction = 'up';
            } else if (event.key === 'ArrowDown') {
                direction = 'down';
            }

            if (direction) {
                socket.send(JSON.stringify({
                    'player': 'player1', // Change as needed to identify the player
                    'direction': direction
                }));
            }
        });

        document.addEventListener('keyup', function(event) {
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                socket.send(JSON.stringify({
                    'player': 'player1', // Change as needed to identify the player
                    'direction': null
                }));
            }
        });

        // Fetch tournaments for a specific user
        fetchTournaments('example_username'); // Change 'example_username' as needed
    </script>
</body>
</html>